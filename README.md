# MP Dashboard — Wildberries + Ozon (FBO)

Мини-портал для мониторинга ключевых показателей по Wildberries и Ozon.

**ВНИМАНИЕ:** Не забудьте сделать и вставить актуальный скриншот дашборда.

## Функционал

- **Общая сводка**: Агрегированные данные по остаткам на складах, заказам и выкупам за сегодня.
- **Поддержка нескольких аккаунтов**: Данные со всех ваших магазинов Ozon автоматически суммируются.
- **Детализация по товарам (SKU)**:
  - Отображение остатков и движения товаров (в пути к клиенту/от клиента) по каждому SKU.
  - Настраиваемые **алиасы** и порядок сортировки для товаров.
- **Интерактивные детали заказов и выкупов**: Раскрывающиеся списки в плитках "Заказано сегодня" и "Выкуплено сегодня" (для WB) с информацией о времени, городе и складе каждого события.
- **Умное кэширование**: Данные автоматически обновляются каждые 30 минут (в `:00` и `:30` минут часа) для минимизации нагрузки на API и предотвращения блокировок.

## Стек технологий

- **Бэкенд**: Python 3.12, Flask, Gunicorn
- **Кэширование**: Flask-Caching (файловая система)
- **Валидация данных**: Pydantic
- **База данных**: SQLite (по умолчанию, для хранения временных данных)
- **Фронтенд**: Bootstrap 5 (Bootswatch), JavaScript
- **Веб-сервер**: Nginx (в качестве reverse proxy)
- **База данных**: SQLite (по умолчанию, для хранения временных данных)

## Установка и запуск

#### 1. Клонирование репозитория
```bash
git clone <URL репозитория>
cd mp-dashboard
```

#### 2. Настройка виртуального окружения
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

#### 3. Конфигурация
Создайте файл `.env` в корневой директории проекта (`mp-dashboard/.env`) на основе примера `.env.example`.

```bash
cp -n .env.example .env
```

Заполните `.env` вашими данными:
```env
# Wildberries API токен
WB_API_TOKEN=...

# Ozon — поддержка нескольких магазинов
# Для первого магазина:
OZON_CLIENT_ID_1=...
OZON_API_KEY_1=...
OZON_SKUS_1=123456,789012 # (необязательно, для фильтрации остатков)

# Для второго магазина (и последующих):
OZON_CLIENT_ID_2=...
OZON_API_KEY_2=...
OZON_SKUS_2=...

# Общие настройки
TIMEZONE=Europe/Moscow
SECRET_KEY=super-secret-key-for-flask
```

#### 4. Локальный запуск
Для разработки и тестирования можно запустить приложение напрямую:
```bash
# Через Gunicorn (рекомендуется)
gunicorn --workers 2 --bind 127.0.0.1:8001 wsgi:app

# Или через встроенный сервер Flask (для отладки)
python wsgi.py
```
После запуска дашборд будет доступен по адресу `http://127.0.0.1:8001/`.

## Развертывание (Production)

Проект настроен для работы под управлением `systemd` и `Nginx`.

- **systemd**: Юнит-файл `mp-dashboard.service` обеспечивает автоматический запуск и перезапуск Gunicorn-сервера.
- **Nginx**: Конфигурация для reverse proxy (`:80` → `127.0.0.1:8001`) находится в `/etc/nginx/sites-available/`.

Пример юнита `systemd` (`/etc/systemd/system/mp-dashboard.service`):
```ini
[Unit]
Description=MP Dashboard (Flask) via Gunicorn
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/mp-dashboard
ExecStart=/root/mp-dashboard/.venv/bin/gunicorn --workers 3 --bind 127.0.0.1:8001 wsgi:app
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

## Тестирование

В проекте настроены модульные тесты для сервисного слоя с использованием `pytest`. Тесты **не делают реальных сетевых запросов** (используются моки), поэтому их можно запускать безопасно и быстро.

#### 1. Установка зависимостей для тестирования
```bash
# (активируйте .venv, если еще не сделали)
pip install pytest
```

#### 2. Запуск всех тестов
```bash
pytest
```

## Ключевые особенности кода

#### Структура проекта
Проект имеет четкое разделение на слои:
- `app/routes`: Обработчики HTTP-запросов (контроллеры).
- `app/services`: Логика взаимодействия с внешними API (WB, Ozon).
- `app/presenters`: Подготовка данных для отображения в шаблонах.
- `app/schemas`: Pydantic-схемы для валидации ответов API.
- `app/utils`: Вспомогательные утилиты (алиасы SKU, логика кэша).
- `app/templates`: Jinja2-шаблоны.

#### Кэширование
- Используется `Flask-Caching` с файловым бэкендом, что обеспечивает общий кэш для всех процессов Gunicorn.
- **Таймаут кэша динамический**: Он рассчитывается так, чтобы сбрасываться ровно в `:00` и `:30` минут каждого часа по московскому времени.
- Принудительная очистка кэша доступна по URL `/?force=1`.

#### Алиасы и сортировка SKU
Названия товаров (SKU) могут быть длинными и неудобными. В `app/utils/sku_aliases.py` можно настроить короткие и понятные **алиасы**, а также задать **порядок их отображения** на дашборде.
